---
title: "analysis"
output: html_document
date: "2022-07-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# 
# BiocManager::install("DEqMS")
```

```{r}
library(DEqMS)
library(tidyverse)
library(pheatmap)
```


# Reading data
```{r}
SpC <- read_tsv("data/CellLineCompartment_TCE_SumTickNormalization.tsv", skip=2, show_col_types = FALSE)
annotation <- read_tsv("data/CellLineCompartment_TCE_SumTickNormalization.tsv", n_max=3, col_select = c(-1), col_names = F, show_col_types = FALSE)
```

## create column annotation
```{r}
IPAS_annotation <- read.csv("data/CellLineCompartment_TCE_SumTickNormalization.tsv",sep = "\t", header = F)

## annotation column
IPAS_annotation <- data.frame("Cancer type"= t(IPAS_annotation[1,2:dim(IPAS_annotation)[2]]))

IPAS_annotation$X2 <- as.character(IPAS_annotation$X1)
IPAS_annotation$X2[grep("Breast",IPAS_annotation$X1)] = ("Breast")
IPAS_annotation$X2[grep("Leukemia",IPAS_annotation$X1)] = ("Leukemia")
IPAS_annotation <- data.frame(IPAS_annotation[,-c(1)])
rownames(IPAS_annotation) <- colnames(SpC[-1])
colnames(IPAS_annotation) <- c('disease')
```


```{r}
pie_data <- IPAS_annotation %>% group_by(disease) %>% summarise(count=n()) %>% arrange(desc(count))
pie(pie_data$count, labels = paste0(pie_data$disease, '(', pie_data$count, ')'))
```


# collapse 'Lymphoblast', 'Neuroblastoma', 'Prostate' since the group size is too small for reliable test 
```{r}
IPAS_annotation <- IPAS_annotation %>% mutate(disease = if_else(disease %in% c('Melanoma', 'Lymphoblast', 'Neuroblastoma', 'Prostate'), 'Other', disease))
```




# read-in newest missing protein list
```{r}
missing_protein_df <- readxl::read_xlsx('data/PE2-5.xlsx')
missing_protein_df <- missing_protein_df[-c(1:12), ]
head(missing_protein_df)
```

# filter the latest missing proteins
after filtering, the number of missing proteins reduce from 1856 -> 1581
```{r}
SpC <- SpC %>% filter(Accession %in% missing_protein_df$Accession)
nrow(SpC)
```



# Missing data handling
create data matrix and replace NA with 0
```{r}
SpC_matrix <- as.matrix(SpC[-1])
rownames(SpC_matrix) <-  pull(SpC[1])
# replace missing value with 0 however when calculate log fold change replace missing as 1
SpC_matrix[is.na(SpC_matrix)] <-  0
# won't take log-transformation for analysis
# SpC_matrix <- log2(SpC_matrix + 1)
```



# Data pre-filter
Since the data is normalized not raw data, not use a pre-filter here
<!-- remove proteins that is not confidentially detected -->
```{r}
# N <- min(table(IPAS_annotation$disease))
# keep <- rowSums(SpC_matrix > 1) >= N
# SpC_matrix_dense <- SpC_matrix[keep,]
SpC_matrix_dense <- SpC_matrix
```

The sample Prostate IP0872_1701 H660  has SpC counts of 55539 almost 2 magnitude larger than any other sample
treat it as an outlier
```{r}
boxplot(SpC_matrix_dense)
# colSums(SpC_matrix_dense)
outlier_filter <- which(colnames(SpC_matrix_dense) == 'Prostate IP0872_1701 H660')
SpC_matrix_dense <- SpC_matrix_dense[, -outlier_filter]
IPAS_annotation <- IPAS_annotation[-outlier_filter, , drop=FALSE]
```

# after remove the potential outlier sample
```{r}
boxplot(SpC_matrix_dense)
```



```{r}
boxplot(t(SpC_matrix_dense))
```



# perform test for each of the cancer group
```{r}
res <- nonpar_test(SpC_matrix_dense, 'Breast', IPAS_annotation$disease, 'fisher')
```


# post filtering
An effect size filter improves the reproducibility in spectral counting-based comparative proteomics
```{r}
top_res <- topTable(res, fold_change = 1, PAjusted = 0.05)
```

# Heatmap for the entire data matrix
```{r}
IPAS_annotation_breast <- IPAS_annotation %>% mutate(disease = if_else(disease == 'Breast', 'Breast', 'Other'))
# annotation_col is a dataframe with rownames corresponding to the colnames in the feeded matrix
pheatmap(log2(SpC_matrix_dense[rownames(res_lst$'Breast'), ] + 1),
         #fontsize_col = 5, 
         #fontsize_row = 4,
         show_rownames = F,
         show_colnames = F,
         cluster_cols = F,
         cluster_rows = T,
         annotation_col = IPAS_annotation_breast)
```



```{r}
res_lst <- list()
cancers <- unique(IPAS_annotation$disease)
for(case in cancers) {
  res <- nonpar_test(SpC_matrix_dense, case = case, groups = IPAS_annotation$disease)
  top_res <- topTable(res, fold_change = 1, PAjusted = 0.01)
  res_lst[[case]] <- top_res
}
```

res_lst
```{r}
unique_DEPs <- unique(unlist(lapply(res_lst, rownames)))
```


# try use venn diagram to show uniquely missing DEPs in each cancer group
```{r}
# library(VennDiagram)
# venn.diagram(
#   x = lapply(res_lst, rownames)[1:5],
#   category.names =  names(lapply(res_lst, rownames))[1:5],
#   filename = 'output/venn_diagramm.png',
#   output=T
# )
```


 Breast         Colon       Gastric        Glioma      Leukemia LungSmallCell   Lymphoblast      Melanoma Neuroblastoma         NSCLC       Ovarian 
   39            10             9            10            15            27             2             7             2            60            15 
   Pancreatic      Prostate 
           29             5 
```{r}
# if (!require(devtools)) install.packages("devtools")
# devtools::install_github("yanlinlin82/ggvenn")
library(ggvenn)

unique_proteins_subsets <- lapply(res_lst, rownames)
# check number of missing proteins in each cancer type
# lapply(unique_proteins_subsets, length)

ggvenn(
  unique_proteins_subsets[c('NSCLC', 'Breast', 'Pancreatic', 'LungSmallCell')], 
  fill_color = c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF"),
  stroke_size = 0.5, set_name_size = 7
  )
```







```{r}
library(RColorBrewer)

breaksList = seq(0, 5, by = 0.05)

# annotation_col is a dataframe with rownames corresponding to the colnames in the feeded matrix
pheatmap(log2(SpC_matrix_dense[unique_DEPs, ] + 1),
         color = colorRampPalette(colors = c("black", "yellow", "darkorange"))(length(breaksList)),
         breaks = breaksList,
         #fontsize_col = 5, 
         #fontsize_row = 4,
         show_rownames = F,
         show_colnames = F,
         cluster_cols =  F,
         cluster_rows = T,
         annotation_col=IPAS_annotation)
```



PCA
```{r}
library(ggfortify)
pca_res <- prcomp(t(SpC_matrix_dense[unique_DEPs, ]))
autoplot(pca_res, data = IPAS_annotation, colour = 'disease')
SpC_matrix_dense[unique_DEPs, ]
```



```{r}
missing_DEPs_info <- missing_protein_df %>% filter(Accession %in% unique_DEPs)
```



```{r}
pie(table(missing_DEPs_info$PE))
```



```{r}

```


